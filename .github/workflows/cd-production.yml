name: Production CI/CD

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger only on version tag push

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production  # optional: requires manual approval
    steps:
      # Checkout code if needed for compose files
      - name: Checkout code
        uses: actions/checkout@v3

      # Set SHA and VERSION tags
      - name: Set IMAGE_TAGS
        run: |
          # Short SHA of the commit that triggered the staging build
          SHA_TAG=$(echo $GITHUB_SHA | cut -c1-7)
          # VERSION_TAG from the Git tag push (e.g., v1.2.3)
          VERSION_TAG=${GITHUB_REF#refs/tags/}

          echo "SHA_TAG=$SHA_TAG" >> $GITHUB_ENV
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV

      # Log in to GHCR
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # Tag SHA image with version and push to GHCR
      - name: Tag and push version tag
        run: |
          echo "Tagging and pushing images with version $VERSION_TAG"

          # Web image
          docker pull ghcr.io/jacobwn/househub/web:$SHA_TAG
          docker tag ghcr.io/jacobwn/househub/web:$SHA_TAG ghcr.io/jacobwn/househub/web:$VERSION_TAG
          docker push ghcr.io/jacobwn/househub/web:$VERSION_TAG

          # Nginx image
          docker pull ghcr.io/jacobwn/househub/nginx:$SHA_TAG
          docker tag ghcr.io/jacobwn/househub/nginx:$SHA_TAG ghcr.io/jacobwn/househub/nginx:$VERSION_TAG
          docker push ghcr.io/jacobwn/househub/nginx:$VERSION_TAG

      - name: Trigger deploy on server
        uses: appleboy/ssh-action@v1
        env:
          VERSION_TAG: ${{ env.VERSION_TAG }}
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          envs: VERSION_TAG
          script: /srv/househub-infra/scripts/bootstrap.sh prod $VERSION_TAG
