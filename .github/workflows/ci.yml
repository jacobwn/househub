name: CI/CD Pipeline

# Trigger CI on pull requests
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  # ------------------------
  # Continuous Integration
  # ------------------------
  # test:
  #   name: Run Tests
  #   runs-on: self-hosted
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Run fake tests
  #       run: |
  #         echo "Running unit tests..."
  #         echo "All tests passed âœ…"

  # ------------------------
  # Staging Deployment
  # ------------------------
  staging:
    name: Deploy to Staging
    needs: test
    runs-on: [self-hosted, staging]
    environment:
      name: staging
    env:
      TEST_SECRET: ${{ secrets.TEST_SECRET }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via Docker Compose (Staging)
        run: |
          echo "Deploying to staging..."
          docker compose -p staging -f docker-compose.yaml -f docker-compose.staging.yaml up -d
          docker ps

  # ------------------------
  # Production Deployment
  # ------------------------
  production:
    name: Deploy to Production
    needs: staging
    runs-on: [self-hosted, production]
    environment:
      name: production
    env:
      TEST_SECRET: ${{ secrets.TEST_SECRET }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via Docker Compose (Production)
        run: |
          echo "Deploying to production..."
          docker compose -p prod -f docker-compose.yaml -f docker-compose.prod.yaml up -d
          docker ps
