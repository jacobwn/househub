name: Staging CI/CD

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      2️⃣ Log in to GitHub Container Registry
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # 3️⃣ Set SHA tag as environment variable
      - name: Set IMAGE_TAG from commit SHA
        run: echo "IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV

      # Step 1: Build Next.js server image
      - name: Build web image
        run: docker build -f ./services/web/Dockerfile.web.prod -t ghcr.io/${{ github.repository }}/web:$IMAGE_TAG ./services/web

      - name: Push web image
        run: docker push ghcr.io/${{ github.repository }}/web:$IMAGE_TAG

      # Step 2: Build Nginx image
      - name: Build nginx image
        run: docker build -f ./infra/nginx/Dockerfile.nginx.prod -t ghcr.io/${{ github.repository }}/nginx:$IMAGE_TAG .

      - name: Push nginx image
        run: docker push ghcr.io/${{ github.repository }}/nginx:$IMAGE_TAG


      - name: Copy compose files via SCP
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_PORT }}     # omit if default 22
          source: "docker-compose.yaml,docker-compose.prod.yaml"
          target: /home/deploy/app/



      # - name: Deploy on server
      #   uses: appleboy/ssh-action@v1.2.4
      #   with:
      #     host: ${{ secrets.STAGING_HOST }}
      #     username: ${{ secrets.STAGING_USER }}
      #     key: ${{ secrets.STAGING_SSH_KEY }}
      #     env:
      #       IMAGE_TAG: ${{ env.IMAGE_TAG }}
      #     script: |
      #       cd /home/deploy/app
      #       echo "IMAGE_TAG=$IMAGE_TAG" > .env
      #       docker compose -f docker-compose.yaml -f docker-compose.prod.yaml pull
      #       docker compose -f docker-compose.yaml -f docker-compose.prod.yaml up -d



      # - name: Sync docker-compose files
      #   uses: burnett01/rsync-deployments@7.1.0
      #   with:
      #     switches: -avz --progress
      #     path: |
      #       ./docker-compose.yaml
      #     remote_path: /home/deploy/app/
      #     remote_host: ${{ secrets.STAGING_HOST }}
      #     remote_user: ${{ secrets.STAGING_USER }}
      #     remote_key: ${{ secrets.STAGING_SSH_KEY }}

      # 6️⃣ Deploy to staging droplet via SSH
      # - name: Deploy to staging droplet
      #   uses: appleboy/ssh-action@v0.1.7
      #   with:
      #     host: ${{ secrets.STAGING_HOST }}
      #     username: ${{ secrets.STAGING_USER }}
      #     key: ${{ secrets.STAGING_SSH_KEY }}
      #     source: |
      #       ./docker-compose.yaml
      #       ./docker-compose.prod.yaml
      #     target: /home/deploy/app/
      #     script: |
      #       cd /home/deploy/app
      #       echo "IMAGE_TAG=$IMAGE_TAG" > .env
      #       docker compose -f docker-compose.yaml -f docker-compose.prod.yaml pull
      #       docker compose -f docker-compose.yaml -f docker-compose.prod.yaml up -d

      # # 7️⃣ Optional: Confirm deployed image
      # - name: Show deployed image
      #   uses: appleboy/ssh-action@v0.1.7
      #   with:
      #     host: ${{ secrets.STAGING_HOST }}
      #     username: ${{ secrets.STAGING_USER }}
      #     key: ${{ secrets.STAGING_SSH_KEY }}
      #     script: docker images | grep app
